
<div id="screen">
  <div id="signDiv">
    <h1>Lambic Engine üçæ</h1>
    Username: <input id="signDiv-username" type="text"></input><br>
    Password: <input id="signDiv-password" type="text"></input>
    <button id="signDiv-signIn">Sign In</button>
    <button id="signDiv-signUp">Sign Up</button>
  </div>

  <div id="gameDiv" style="display:none;">
    <canvas id="ctx" width="576" height="576" style="border:1px solid #D3D3D3; position: absolute; left: 10; top: 10; z-index: 0;"></canvas>
    <canvas id="lighting" width="576" height="576" style ="position: absolute; left: 10; top: 10; z-index: 1;"></canvas>
  </div>

  <div id="UI" style="height:576px;display:none; position: absolute; left: 596; top: 10;">
    <div id="chat">
      <div id="chat-text" style="width:288px;height:550px;overflow-y:scroll;border:1px solid #D3D3D3;">
      </div>

      <form id="chat-form">
        <input id="chat-input" type="text" style="width:288px"></input>
      </form>
    </div>
  </div>
</div>

<script src="/client/socket.js"></script>

<script>
  var WIDTH = 576;
  var HEIGHT = 576;
  var world = [];
  var tileSize = 0;
  var mapSize = 0;

  var socket = io();

  //SIGN IN
  var signDiv = document.getElementById('signDiv');
  var signDivUsername = document.getElementById('signDiv-username');
  var signDivPassword = document.getElementById('signDiv-password');
  var signDivSignIn = document.getElementById('signDiv-signIn');
  var signDivSignUp = document.getElementById('signDiv-signUp');

  signDivSignIn.onclick = function(){
    socket.emit('signIn',{username:signDivUsername.value,password:signDivPassword.value});
  }

  signDivSignUp.onclick = function(){
    socket.emit('signUp',{username:signDivUsername.value,password:signDivPassword.value});
  }

  socket.on('signInResponse',function(data){
    if(data.success){
      signDiv.style.display = 'none';
      gameDiv.style.display = 'inline-block';
      UI.style.display = 'inline-block';
    } else
      alert('Sign-in failed.')
  });

  socket.on('signUpResponse',function(data){
    if(data.success){
      alert('Sign-up successful.')
    } else
      alert('Sign-up failed.')
  });

  // CHAT & COMMANDS
  var chatText = document.getElementById('chat-text');
  var chatInput = document.getElementById('chat-input');
  var chatForm = document.getElementById('chat-form');

  socket.on('addToChat',function(data){
    chatText.innerHTML += '<div>' + data + '</div>';
  });

  socket.on('evalAnswer',function(data){
    chatText.innerHTML += '<div>' + data + '</div>';
    console.log(data);
  });

  chatForm.onsubmit = function(e){
    e.preventDefault();
    if(chatInput.value[0] === '/')
      socket.emit('evalServer',chatInput.value.slice(1));
    else
      socket.emit('sendMsgToServer',chatInput.value);
    chatInput.value = '';
  }

  // GAME

  // IMAGES
  var Img = {};

  // tiles
  Img.grassland = new Image();
  Img.grassland.src = '/client/img/tiles/grassland.png';
  Img.water1 = new Image();
  Img.water1.src = '/client/img/tiles/water1.png';
  Img.water2 = new Image();
  Img.water2.src = '/client/img/tiles/water2.png';
  Img.water3 = new Image();
  Img.water3.src = '/client/img/tiles/water3.png';
  Img.hforest = new Image();
  Img.hforest.src = '/client/img/tiles/hforest.png';
  Img.forest = new Image();
  Img.forest.src = '/client/img/tiles/forest.png';
  Img.brush = new Image();
  Img.brush.src = '/client/img/tiles/brush.png';
  Img.rocks = new Image();
  Img.rocks.src = '/client/img/tiles/rocks.png';
  Img.mountain = new Image();
  Img.mountain.src = '/client/img/tiles/mountain.png';

  // characters

  // objects
  Img.arrow1 = new Image();
  Img.arrow1.src = '/client/img/bullets/arrow1.png';
  Img.arrow2 = new Image();
  Img.arrow2.src = '/client/img/bullets/arrow2.png';
  Img.arrow3 = new Image();
  Img.arrow3.src = '/client/img/bullets/arrow3.png';
  Img.arrow4 = new Image();
  Img.arrow4.src = '/client/img/bullets/arrow4.png';
  Img.arrow5 = new Image();
  Img.arrow5.src = '/client/img/bullets/arrow5.png';
  Img.arrow6 = new Image();
  Img.arrow6.src = '/client/img/bullets/arrow6.png';
  Img.arrow7 = new Image();
  Img.arrow7.src = '/client/img/bullets/arrow7.png';
  Img.arrow8 = new Image();
  Img.arrow8.src = '/client/img/bullets/arrow8.png';

  var ctx = document.getElementById('ctx').getContext('2d');
  var lighting = document.getElementById('lighting').getContext('2d');
  ctx.font = '30px Arial';

  // PLAYER
  var Player = function(initPack){
    var self = {};
    self.id = initPack.selfId;
    self.number = initPack.number;
    self.x = initPack.x;
    self.y = initPack.y;
    self.loc = initPack.loc;
    self.z = initPack.z;
    self.facing = 'down';
    self.hp = initPack.hp;
    self.hpMax = initPack.hpMax;
    self.mana = initPack.mana;
    self.manaMax = initPack.manaMax;

    self.draw = function(){
      var x = self.x - Player.list[selfId].x + WIDTH/2;
      var y = self.y - Player.list[selfId].y + HEIGHT/2;

      // hp and mana bars
      var hpWidth = 60 * self.hp / self.hpMax;
      var manaWidth = 60 * self.mana / self.manaMax;

      ctx.fillStyle = 'red';
      ctx.fillRect(x - 30,y - 50,60,8);
      ctx.fillStyle = 'green';
      ctx.fillRect(x - hpWidth/2,y - 50,hpWidth,8);
      ctx.fillStyle = 'red';
      ctx.fillRect(x - 30,y - 40,60,5);
      ctx.fillStyle = 'blue';
      ctx.fillRect(x - manaWidth/2,y - 40,manaWidth,5);
      ctx.fillStyle = 'black';

      // character sprite
      ctx.fillText(self.number,x, y);
    }

    Player.list[selfId] = self;
    return self;
  }
  Player.list = {};

  // BULLETS
  var Bullet = function(initPack){
    var self = {};
    self.id = initPack.id;
    self.angle = initPack.angle;
    self.number = initPack.number;
    self.x = initPack.x;
    self.y = initPack.y;
    self.z = initPack.z;

    self.draw = function(){
      function drawArrow(angle){
        var x = self.x - Player.list[selfId].x + WIDTH/2;
        var y = self.y - Player.list[selfId].y + HEIGHT/2;

        if(angle >= -120 && angle < -60){
          ctx.drawImage(Img.arrow1, x, y, tileSize, tileSize);
        } else if(angle >= -60 && angle < -30){
          ctx.drawImage(Img.arrow2, x, y, tileSize, tileSize);
        } else if(angle >= -30 && angle < 30){
          ctx.drawImage(Img.arrow3, x, y, tileSize, tileSize);
        } else if(angle >= 30 && angle < 60){
          ctx.drawImage(Img.arrow4, x, y, tileSize, tileSize);
        } else if(angle >= 60 && angle < 120){
          ctx.drawImage(Img.arrow5, x, y, tileSize, tileSize);
        } else if(angle >= 120 && angle < 150){
          ctx.drawImage(Img.arrow6, x, y, tileSize, tileSize);
        } else if(angle >= 150 && angle > -150){
          ctx.drawImage(Img.arrow7, x, y, tileSize, tileSize);
        } else {
          ctx.drawImage(Img.arrow8, x, y, tileSize, tileSize);
        }
      }
      drawArrow(self.angle);
    }

    Bullet.list[self.id] = self;
    return self;
  }
  Bullet.list = {};

  // player's id
  var selfId = null;

  // init
  socket.on('init',function(data){
    if(data.selfId)
      selfId = data.selfId;
    // { player : [{id:123,number:'1',x:0,y:0},{id:1,x:0,y:0}] bullet: []}
    for(var i = 0 ; i < data.player.length; i++){
      new Player(data.player[i]);
    }
    for(var i = 0 ; i < data.bullet.length; i++){
      new Bullet(data.bullet[i]);
    }
  });

  // update
  socket.on('update',function(data){
    // { player : [{id:123,number:'1',x:0,y:0},{id:1,x:0,y:0}] bullet: []}
    for(var i = 0 ; i < data.player.length; i++){
      var pack = data.player[i];
      var p = Player.list[pack.id];
      if(p){
        if(pack.x !== undefined)
          p.x = pack.x;
        if(pack.y !== undefined)
          p.y = pack.y;
        if(pack.loc !== undefined)
          p.loc = pack.loc;
        if(pack.z !== undefined)
          p.z = pack.z;
        if(pack.facing !== undefined)
          p.facing = pack.facing;
        if(pack.hp !== undefined)
          p.hp = pack.hp;
        if(pack.hpMax !== undefined)
          p.hpMax = pack.hpMax;
        if(pack.mana !== undefined)
          p.mana = pack.mana;
        if(pack.manaMax !== undefined)
          p.manaMax = pack.manaMax;
      }
    }
    for(var i = 0 ; i < data.bullet.length; i++){
      var pack = data.bullet[i];
      var b = Bullet.list[data.bullet[i].id];
      if(b){
        if(pack.x !== undefined)
          b.x = pack.x;
        if(pack.y !== undefined)
          b.y = pack.y;
        if(pack.z !== undefined)
          b.z = pack.z;
      }
    }
  });

  // remove
  socket.on('remove',function(data){
    // {player:[12323],bullet:[12323,123123]}
    for(var i = 0 ; i < data.player.length; i++){
      delete Player.list[data.player[i]];
    }
    for(var i = 0 ; i < data.bullet.length; i++){
      delete Bullet.list[data.bullet[i]];
    }
  });

  // DRAW TO SCREEN

  //cyclical animation counter
  var w = 0;
  setInterval(function(){
    if(w === 2){
      w = 0;
    } else {
      w++;
    }
  },600);

  setInterval(function(){
    if(!selfId) // check that player is signed in
      return;
    ctx.clearRect(0,0,WIDTH,HEIGHT);
    renderMap();
    if(Player.list[selfId].z === 0){ //check if player is outside
      renderLighting();
    };
    for(var i in Player.list)
      Player.list[i].draw();
    for(var i in Bullet.list)
      Bullet.list[i].draw();
    viewport.update(Player.list[selfId].loc[0],Player.list[selfId].loc[1]);
    console.log(Player.list[selfId].loc);
  },40);

  // RENDER MAP

  // MAP DATA
  socket.on('mapData',function(data){
    world = data.world;
    tileSize = data.tileSize;
    mapSize = data.mapSize;
    tempus = data.tempus;
  });

  var getTile = function(c,r){
    return world[c][r];
  };

  // update environment
  tempus = null;

  socket.on('tempus',function(data){
    tempus = data.tempus;
  });

  // viewport
  var tileRes = WIDTH/tileSize; //start fixing here !!!

  var viewport = {
    screen: [WIDTH,HEIGHT],
    startTile: [0,0],
    endTile: [0,0],
    offset: [0,0],
    // takes player's loc as argument
    update: function(c,r){
      //this.offset[0] = Math.floor((this.screen[0]/2) - c);
      //this.offset[1] = Math.floor((this.screen[1]/2) - r);

      var tile = [Math.floor(c/tileSize),Math.floor(r/tileSize)];

      this.startTile[0] = tile[0] - 1 - Math.ceil((this.screen[0]/2) / tileSize);
      this.startTile[1] = tile[1] - 1 - Math.ceil((this.screen[1]/2) / tileSize);

      //if(this.startTile[0] < 0){this.startTile[0] = 0;}
      //if(this.startTile[1] < 0){this.startTile[1] = 0;}

      this.endTile[0] = tile[0] + 1 + Math.ceil((this.screen[0]/2) / tileSize);
      this.endTile[1] = tile[1] + 1 + Math.ceil((this.screen[1]/2) / tileSize);

      if(this.endTile[0] >= mapSize){this.endTile[0] = mapSize - 1;}
      if(this.endTile[1] >= mapSize){this.endTile[1] = mapSize - 1;}
    }
  };

  // renderer
  var renderMap = function(){
    var x = 0;
    var y = 0;

    var base = ctx.createPattern(Img.grassland, "repeat");
    ctx.rect(0,0,WIDTH,HEIGHT);
    ctx.fillStyle = base;
    ctx.fill();
    for (var c = viewport.startTile[0]; c < viewport.endTile[0]; c++) {
      for (var r = viewport.startTile[1]; r < viewport.endTile[1]; r++) {
        if(c < 0){
          continue;
        } else {
          var tile = getTile(c, r);
          if(tile === 0){
            if(w === 0){
              ctx.drawImage(
              Img.water1, // image
              x * tileSize, // target x
              y * tileSize, // target y
              tileSize, // target width
              tileSize // target height
              );
            } else if(w === 1){
              ctx.drawImage(
              Img.water2, // image
              x * tileSize, // target x
              y * tileSize, // target y
              tileSize, // target width
              tileSize // target height
              );
            } else {
              ctx.drawImage(
              Img.water3, // image
              x * tileSize, // target x
              y * tileSize, // target y
              tileSize, // target width
              tileSize // target height
              );
            }
            y++;
          } else if(tile === 1){ // NEEDS OFFSET !!!
            ctx.drawImage(
            Img.hforest, // image
            x * tileSize, // target x
            y * tileSize, // target y
            tileSize, // target width
            tileSize // target height
            );
            y++;
          } else if(tile === 2){
            ctx.drawImage(
            Img.forest, // image
            x * tileSize, // target x
            y * tileSize, // target y
            tileSize, // target width
            tileSize // target height
            );
            y++;
          } else if(tile === 3){
            ctx.drawImage(
            Img.brush, // image
            x * tileSize, // target x
            y * tileSize, // target y
            tileSize, // target width
            tileSize // target height
            );
            y++;
          } else if(tile === 4){
            ctx.drawImage(
            Img.rocks, // image
            x * tileSize, // target x
            y * tileSize, // target y
            tileSize, // target width
            tileSize // target height
            );
            y++;
          } else if(tile === 5){
            ctx.drawImage(
            Img.mountain, // image
            x * tileSize, // target x
            y * tileSize, // target y
            tileSize, // target width
            tileSize // target height
            );
            y++;
          }
        }
      }
      y = [];
      x++;
    }
  }

  var renderLighting = function(){
    if(tempus === 'IX.p' || tempus === 'X.p' || tempus === 'XI.p' || tempus === 'XII.a' || tempus === 'I.a' || tempus === 'II.a' || tempus === 'III.a'){
      lighting.clearRect(0,0,WIDTH,HEIGHT);
      lighting.fillStyle = "rgba(5, 5, 30, 0.85)"; // night
      lighting.fillRect(0,0,WIDTH,HEIGHT);
    } else if(tempus === 'IV.a'){
      lighting.clearRect(0,0,WIDTH,HEIGHT);
      lighting.fillStyle = "rgba(5, 5, 30, 0.8)"; // early hours
      lighting.fillRect(0,0,WIDTH,HEIGHT);
    } else if(tempus === 'V.a'){
      lighting.clearRect(0,0,WIDTH,HEIGHT);
      lighting.fillStyle = "rgba(5, 5, 30, 0.6)"; // early morning
      lighting.fillRect(0,0,WIDTH,HEIGHT);
    } else if(tempus === 'VI.a'){
      lighting.clearRect(0,0,WIDTH,HEIGHT);
      lighting.fillStyle = "rgba(244, 214, 65, 0.1)"; // sunrise
      lighting.fillRect(0,0,WIDTH,HEIGHT);
    } else if(tempus === 'VII.a'){
      lighting.clearRect(0,0,WIDTH,HEIGHT); // morning / daytime
    } else if(tempus === 'IV.p'){
      lighting.clearRect(0,0,WIDTH,HEIGHT);
      lighting.fillStyle = "rgba(255, 204, 22, 0.07)"; // afternoon
      lighting.fillRect(0,0,WIDTH,HEIGHT);
    } else if(tempus === 'V.p'){
      lighting.clearRect(0,0,WIDTH,HEIGHT);
      lighting.fillStyle = "rgba(255, 204, 22, 0.1)"; // late afternoon
      lighting.fillRect(0,0,WIDTH,HEIGHT);
    } else if(tempus === 'VI.p'){
      lighting.clearRect(0,0,WIDTH,HEIGHT);
      lighting.fillStyle = "rgba(232, 112, 0, 0.25)"; // sunset
      lighting.fillRect(0,0,WIDTH,HEIGHT);
    } else if(tempus === 'VII.p'){
      lighting.clearRect(0,0,WIDTH,HEIGHT);
      lighting.fillStyle = "rgba(5, 5, 30, 0.4)"; // twilight
      lighting.fillRect(0,0,WIDTH,HEIGHT);
    } else if(tempus === 'VIII.p'){
      lighting.clearRect(0,0,WIDTH,HEIGHT);
      lighting.fillStyle = "rgba(5, 5, 30, 0.7)"; // evening
      lighting.fillRect(0,0,WIDTH,HEIGHT);
    }
  }

  // CONTROLS
  document.onkeydown = function(event){
    if(event.keyCode === 68) // d
      socket.emit('keyPress',{inputId:'right',state:true});
    else if(event.keyCode === 83) // s
      socket.emit('keyPress',{inputId:'down',state:true});
    else if(event.keyCode === 65) // a
      socket.emit('keyPress',{inputId:'left',state:true});
    else if(event.keyCode === 87) // w
      socket.emit('keyPress',{inputId:'up',state:true});
    else if(event.keyCode === 32) // space
      socket.emit('keyPress',{inputId:'attack',state:true});
  }

  document.onkeyup = function(event){
    if(event.keyCode === 68) // d
      socket.emit('keyPress',{inputId:'right',state:false});
    else if(event.keyCode === 83) // s
      socket.emit('keyPress',{inputId:'down',state:false});
    else if(event.keyCode === 65) // a
      socket.emit('keyPress',{inputId:'left',state:false});
    else if(event.keyCode === 87) // w
      socket.emit('keyPress',{inputId:'up',state:false});
    else if(event.keyCode === 32) // space
      socket.emit('keyPress',{inputId:'attack',state:false});
  }

  document.onmousemove = function(event){
    var x = -250 + event.clientX - 8;
    var y = -250 + event.clientY - 8;
    var angle = Math.atan2(y,x) / Math.PI * 180;
    socket.emit('keyPress',{inputId:'mouseAngle',state:angle});
  }

  document.oncontextmenu = function(event){
    //event.preventDefault();
  }
</script>
