<div id="signDiv">
  <h1>Lambic Engine üçæ</h1>
  Username: <input id="signDiv-username" type="text"></input><br>
  Password: <input id="signDiv-password" type="text"></input>
  <button id="signDiv-signIn">Sign In</button>
  <button id="signDiv-signUp">Sign Up</button>
</div>

<div id="gameDiv" style="display:none;">
  <canvas id="ctx" width="576" height="576" style="border:1px solid #000000;"></canvas>

  <div id="chat-text" style="width:576px;height:100px;overflow-y:scroll;">
  </div>

  <form id="chat-form">
    <input id="chat-input" type="text" style="width:576px"></input>
  </form>
</div>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

<script>
  var WIDTH = 576;
  var HEIGHT = 576;
  var world = [];
  var tileSize = 0;
  var mapSize = 0;

  var socket = io();

  //SIGN IN
  var signDiv = document.getElementById('signDiv');
  var signDivUsername = document.getElementById('signDiv-username');
  var signDivPassword = document.getElementById('signDiv-password');
  var signDivSignIn = document.getElementById('signDiv-signIn');
  var signDivSignUp = document.getElementById('signDiv-signUp');

  signDivSignIn.onclick = function(){
    socket.emit('signIn',{username:signDivUsername.value,password:signDivPassword.value});
  }

  signDivSignUp.onclick = function(){
    socket.emit('signUp',{username:signDivUsername.value,password:signDivPassword.value});
  }

  socket.on('signInResponse',function(data){
    if(data.success){
      signDiv.style.display = 'none';
      gameDiv.style.display = 'inline-block';
    } else
      alert('Sign-in failed.')
  });

  socket.on('signUpResponse',function(data){
    if(data.success){
      alert('Sign-up successful.')
    } else
      alert('Sign-up failed.')
  });

  // CHAT & COMMANDS
  var chatText = document.getElementById('chat-text');
  var chatInput = document.getElementById('chat-input');
  var chatForm = document.getElementById('chat-form');

  socket.on('addToChat',function(data){
    chatText.innerHTML += '<div>' + data + '</div>';
  });

  socket.on('evalAnswer',function(data){
    chatText.innerHTML += '<div>' + data + '</div>';
    console.log(data);
  });

  chatForm.onsubmit = function(e){
    e.preventDefault();
    if(chatInput.value[0] === '/')
      socket.emit('evalServer',chatInput.value.slice(1));
    else
      socket.emit('sendMsgToServer',chatInput.value);
    chatInput.value = '';
  }

  // GAME

  // IMAGES
  var Img = {};

  // tiles
  Img.grassland = new Image();
  Img.grassland.src = '/client/img/tiles/grassland.png';
  Img.water = new Image();
  Img.water.src = '/client/img/tiles/water.png';
  Img.hforest = new Image();
  Img.hforest.src = '/client/img/tiles/hforest.png';
  Img.forest = new Image();
  Img.forest.src = '/client/img/tiles/forest.png';
  Img.brush = new Image();
  Img.brush.src = '/client/img/tiles/brush.png';
  Img.rocks = new Image();
  Img.rocks.src = '/client/img/tiles/rocks.png';
  Img.mountain = new Image();
  Img.mountain.src = '/client/img/tiles/mountain.png';

  // characters

  // objects

  var ctx = document.getElementById('ctx').getContext('2d');
  ctx.font = '30px Arial';

  // PLAYER
  var Player = function(initPack){
    var self = {};
    self.id = initPack.id;
    self.number = initPack.number;
    self.x = initPack.x;
    self.y = initPack.y;
    self.loc = initPack.loc;
    self.hp = initPack.hp;
    self.hpMax = initPack.hpMax;
    self.mana = initPack.mana;
    self.manaMax = initPack.manaMax;

    self.draw = function(){
      var x = self.x - Player.list[selfId].x + WIDTH/2;
      var y = self.y - Player.list[selfId].y + HEIGHT/2;

      // hp and mana bars
      var hpWidth = 60 * self.hp / self.hpMax;
      var manaWidth = 60 * self.mana / self.manaMax;

      ctx.fillStyle = 'red';
      ctx.fillRect(x - 30,y - 50,60,8);
      ctx.fillStyle = 'green';
      ctx.fillRect(x - hpWidth/2,y - 50,hpWidth,8);
      ctx.fillStyle = 'red';
      ctx.fillRect(x - 30,y - 40,60,8);
      ctx.fillStyle = 'blue';
      ctx.fillRect(x - manaWidth/2,y - 40,manaWidth,8);
      ctx.fillStyle = 'black';

      // character sprite
      ctx.fillText(self.number,x, y);
    }

    Player.list[self.id] = self;
    return self;
  }
  Player.list = {};

  // BULLETS
  var Bullet = function(initPack){
    var self = {};
    self.id = initPack.id;
    self.number = initPack.number;
    self.x = initPack.x;
    self.y = initPack.y;

    self.draw = function(){
      //var width = Img.bullet.width/2;
      //var height = Img.bullet.height/2;

      var x = self.x - Player.list[selfId].x + WIDTH/2;
      var y = self.y - Player.list[selfId].y + HEIGHT/2;

      ctx.fillRect(x-5,y-5,10,10); // switch to image soon
    }

    Bullet.list[self.id] = self;
    return self;
  }
  Bullet.list = {};

  // player's id
  var selfId = null;

  // init
  socket.on('init',function(data){
    if(data.selfId)
      selfId = data.selfId;
    // { player : [{id:123,number:'1',x:0,y:0},{id:1,x:0,y:0}] bullet: []}
    for(var i = 0 ; i < data.player.length; i++){
      new Player(data.player[i]);
    }
    for(var i = 0 ; i < data.bullet.length; i++){
      new Bullet(data.bullet[i]);
    }
  });

  // update
  socket.on('update',function(data){
    // { player : [{id:123,number:'1',x:0,y:0},{id:1,x:0,y:0}] bullet: []}
    for(var i = 0 ; i < data.player.length; i++){
      var pack = data.player[i];
      var p = Player.list[pack.id];
      if(p){
        if(pack.x !== undefined)
          p.x = pack.x;
        if(pack.y !== undefined)
          p.y = pack.y;
        if(pack.hp !== undefined)
          p.hp = pack.hp;
        if(pack.loc !== undefined)
          p.loc = pack.loc;
        if(pack.hpMax !== undefined)
          p.hpMax = pack.hpMax;
        if(pack.mana !== undefined)
          p.mana = pack.mana;
        if(pack.manaMax !== undefined)
          p.manaMax = pack.manaMax;
      }
    }
    for(var i = 0 ; i < data.bullet.length; i++){
      var pack = data.bullet[i];
      var b = Bullet.list[data.bullet[i].id];
      if(b){
        if(pack.x !== undefined)
          b.x = pack.x;
        if(pack.y !== undefined)
          b.y = pack.y;
      }
    }
  });

  // remove
  socket.on('remove',function(data){
    // {player:[12323],bullet:[12323,123123]}
    for(var i = 0 ; i < data.player.length; i++){
      delete Player.list[data.player[i]];
    }
    for(var i = 0 ; i < data.bullet.length; i++){
      delete Bullet.list[data.bullet[i]];
    }
  });

  // draw players & bullets
  setInterval(function(){
    if(!selfId)
      return;
    viewport.update(Player.list[selfId].loc[0],Player.list[selfId].loc[1]);
    console.log(Player.list[selfId].loc);
    ctx.clearRect(0,0,WIDTH,HEIGHT);
    renderMap();
    for(var i in Player.list)
      Player.list[i].draw();
    for(var i in Bullet.list)
      Bullet.list[i].draw();
  },40);

  // RENDER MAP

  // MAP DATA
  socket.on('mapData',function(data){
    world = data.world;
    tileSize = data.tileSize;
    mapSize = data.mapSize;
  });

  var tileRes = WIDTH/tileSize;

  var getTile = function(c,r){
    return world[c][r];
  };

  // viewport
  var viewport = {
    screen: [WIDTH,HEIGHT],
    startTile: [0,0],
    endTile: [0,0],
    offset: [0,0],
    // takes player's loc as argument
    update: function(c,r){
      this.offset[0] = Math.floor((this.screen[0]/2) - c);
      this.offset[1] = Math.floor((this.screen[1]/2) - r);

      var tile = [Math.floor(c/tileSize),Math.floor(r/tileSize)];

      this.startTile[0] = tile[0] - 1 - Math.ceil((this.screen[0]/2) / tileSize);
      this.startTile[1] = tile[1] - 1 - Math.ceil((this.screen[1]/2) / tileSize);

      if(this.startTile[0] < 0){this.startTile[0] = 0;}
      if(this.startTile[1] < 0){this.startTile[1] = 0;}

      this.endTile[0] = tile[0] + 1 + Math.ceil((this.screen[0]/2) / tileSize);
      this.endTile[1] = tile[1] + 1 + Math.ceil((this.screen[1]/2) / tileSize);

      if(this.endTile[0] >= mapSize){this.endTile[0] = mapSize - 1;}
      if(this.endTile[1] >= mapSize){this.endTile[1] = mapSize - 1;}
    }
  };

  // renderer
  var renderMap = function(){
    var x = 0;
    var y = 0;

    var base = ctx.createPattern(Img.grassland, "repeat");
    ctx.rect(0,0,WIDTH,HEIGHT);
    ctx.fillStyle = base;
    ctx.fill();
    for (var c = viewport.startTile[0]; c < viewport.endTile[0]; c++) {
      for (var r = viewport.startTile[1]; r < viewport.endTile[1]; r++) {
        var tile = getTile(c, r);
        if(tile === 0){
          ctx.drawImage(
          Img.water, // image
          x * tileSize, // target x
          y * tileSize, // target y
          tileSize, // target width
          tileSize // target height
          );
          y++;
        } else if(tile === 1){ // NEEDS OFFSET !!!
          ctx.drawImage(
          Img.hforest, // image
          x * tileSize, // target x
          y * tileSize, // target y
          tileSize, // target width
          tileSize // target height
          );
          y++;
        } else if(tile === 2){
          ctx.drawImage(
          Img.forest, // image
          x * tileSize, // target x
          y * tileSize, // target y
          tileSize, // target width
          tileSize // target height
          );
          y++;
        } else if(tile === 3){
          ctx.drawImage(
          Img.brush, // image
          x * tileSize, // target x
          y * tileSize, // target y
          tileSize, // target width
          tileSize // target height
          );
          y++;
        } else if(tile === 4){
          ctx.drawImage(
          Img.rocks, // image
          x * tileSize, // target x
          y * tileSize, // target y
          tileSize, // target width
          tileSize // target height
          );
          y++;
        } else if(tile === 5){
          ctx.drawImage(
          Img.mountain, // image
          x * tileSize, // target x
          y * tileSize, // target y
          tileSize, // target width
          tileSize // target height
          );
          y++;
        }
      }
      y = [];
      x++;
    }
  }

  // CONTROLS
  document.onkeydown = function(event){
    if(event.keyCode === 68) // d
      socket.emit('keyPress',{inputId:'right',state:true});
    else if(event.keyCode === 83) // s
      socket.emit('keyPress',{inputId:'down',state:true});
    else if(event.keyCode === 65) // a
      socket.emit('keyPress',{inputId:'left',state:true});
    else if(event.keyCode === 87) // w
      socket.emit('keyPress',{inputId:'up',state:true});
    else if(event.keyCode === 32) // space
      socket.emit('keyPress',{inputId:'attack',state:true});
  }

  document.onkeyup = function(event){
    if(event.keyCode === 68) // d
      socket.emit('keyPress',{inputId:'right',state:false});
    else if(event.keyCode === 83) // s
      socket.emit('keyPress',{inputId:'down',state:false});
    else if(event.keyCode === 65) // a
      socket.emit('keyPress',{inputId:'left',state:false});
    else if(event.keyCode === 87) // w
      socket.emit('keyPress',{inputId:'up',state:false});
    else if(event.keyCode === 32) // space
      socket.emit('keyPress',{inputId:'attack',state:false});
  }

  document.onmousemove = function(event){
    var x = -250 + event.clientX - 8;
    var y = -250 + event.clientY - 8;
    var angle = Math.atan2(y,x) / Math.PI * 180;
    socket.emit('keyPress',{inputId:'mouseAngle',state:angle});
  }
</script>
